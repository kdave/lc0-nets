#!/bin/bash

file=lc0-nets.json

if [ -z "$1" ]; then
	echo "Usage: $0 command"
	echo
	echo "Commands:"
	echo "- urls          - print the urls"
	echo "- names         - print names of the nets"
	echo "- froms         - print names of the authors"
	echo "- download      - download all urls"
	echo "- genscript     - generate the lc0 runner scripts"
	exit 0
fi

if [ "$1" = 'urls' ]; then
	jq -r '.[].url' < "$file"
fi

if [ "$1" = 'names' ]; then
	jq -r '.[].name' < "$file"
fi

if [ "$1" = 'froms' ]; then
	jq -r '.[].from' < "$file" | sort | uniq -c
fi

if [ "$1" = 'download' ]; then
	i=0
	net=
	while :; do
		net=$(jq -r ".[$i]" < "$file")
		i=$(($i+1))
		if [[ $net =~ null ]]; then
			break
		fi
		from=`echo "$net" | jq -r '.from'`
		if [ -n "$2" -a "$2" != "$from" ]; then
			continue
		fi
		url=`echo "$net" | jq -r '.url'`
		fname=`basename "$url"`
		wget -c "$url" -O "$from-$fname"
	done
fi

if [ "$1" = 'genscript' -o "$1" = 'genscripts' ]; then
	i=0
	net=
	while :; do
		net=$(jq -r ".[$i]" < "$file")
		i=$(($i+1))
		if [[ $net =~ null ]]; then
			break
		fi
		from=`echo "$net" | jq -r '.from'`
		url=`echo "$net" | jq -r '.url'`
		name=`echo "$net" | jq -r '.name'`
		desc=`echo "$net" | jq -r '.desc'`
		fname=`basename "$url"`
		netname="$from-$fname"
		out="lc0-$from-$name"
		path="`pwd`"
		echo "#!/bin/sh" > "$out"
		chmod 755 "$out"
		echo "# WARNING: this file is autogenerated and will be overwritten" >> "$out"
		echo >> "$out"
		echo "# From: $from ($url)" >> "$out"
		echo -e "$desc" | sed -e 's/^/# /' >> "$out"
		echo >> "$out"
		echo "lc0 \"--weights=$path/$netname\"" >> "$out"
		echo Generated "$out"
	done
fi
